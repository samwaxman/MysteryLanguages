#lang racket

(require (prefix-in Cond- "../Conditionals/Conditionals3.rkt")
         "../ML-Helpers.rkt"
         "MV1and2Comminalities.rkt"
         (for-syntax syntax/parse))
(provide
 (except-out (unprefix-out Cond- "../Conditionals/Conditionals3.rkt")
             Cond-#%let
             Cond-#%app
             Cond-#%id)
 (rename-out [my-app #%app])
 #%let
 #%lambda
 #%func
 #%reassign
 #%id)

(define-syntax (my-app stx)
  (syntax-parse stx
    [(_ proc args ...)
     (with-syntax ([(boxed-args ...) (generate-temporaries #'(args ...))]
                   [(inner-args ...) (generate-temporaries #'(args ...))])
       #'(let ([evaluated-proc proc])
           (if (function? evaluated-proc)
               (let* ([boxed-args (expand-arg args)] ...
                      [inner-args (box (unbox boxed-args))] ...
                      [result (#%arity-app (function-lam evaluated-proc) inner-args ...)])
                 (set-box! boxed-args (unbox inner-args)) ...
                 result)
               (#%arity-app evaluated-proc args ...))))]))
